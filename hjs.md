### hjs流程梳理

#### hjs产品说明

hjs提供的产品包，大概100w一个这样的规模。根据合规要求，这种产品包不能销售给200个人以上。所以为简化逻辑，按份数来进行售卖。最低购买一份，也就是说最低购买金额是5000元。如果根据channel来进行判断的话基本上就有4中channel属于hjs产品。

* 这里有个问题，如果不能超过200人的话，那么设置最低起购金额为5000不行吗？不行，因为这样的话会导致剩余的金额少于5000，这个产品包就永远卖不完了。那么如果设置最后一笔没有5000的限额不行吗？考虑到还有支付失败、等待的状况，最好就不要在后台逻辑中做这样的hack了。
* 还有就是hjs产品要尽量一个一个卖，好像要求是卖完了这一个才能继续开售下一个产品包。**所以这个地方还要和@lyb确认一下，当时是怎么做到的卖完一个才能继续卖下一个的。**

#### 购买hjs产品

用户选择了想要购买的hjs产品，走正常产品的支付流程。然后生成资产。这时候还和hjs一点关系都没有，生成的资产状态是INVEST\_START。

而后，通过离线跑批任务来批量向hjs进行投资。**这里需要确认一下投资的间隔有多长。**首先根据channel和时间，获取到所有的hjs产品，根据产品找到所有购买相应产品的资产。首先会和hjs同步产品，确认该款产品存在，然后将资产依次向hjs同步，同步成功后，会将资产的状态置为INVEST\_SUCCESS, 同时生成invest记录。到此，认购过程结束。

讲道理如果投资失败咋办。资产都处于INVEST\_START状态了。那就一直不断尝试呗，同时会发邮件看为啥失败。但是这种情况比较少吧。

**所有的请求都经过3DES加密。这个加密算法可以看看。总之所有的URL都需要进行签名或者加密。可以看看这些加密算法。**

**更新这些东西需在同一个transaction里面来进行。可以看看orm框架中的transaction实现。**

#### hjs产品到期

在经过漫长的等待之后，**现在我看产品基本上都是一年期。没有2年期或者3年期的吧。这个可以明天确认一下。**我们会在产品到期前3天来进行还款试算，就是和hjs同步一下每笔资产到期时候的金额。同样，处理的逻辑都是差不多的，这边通过产品的到期日和产品的channel，获取到所有马上即将到期的hjs产品。然后查询这个产品在hjs下边对应的所有资产记录。这个接口有条数限制，所以我们每次基本上只取50条记录。同时查询在zw的资产，计算资产到期应该得到的本息。将本息的金额和hjs返回的金额进行对照。如果金额一致或者差几分，那么没有问题，按照zw的金额，生成sell记录。表示hjs已经同意我们进行交割，然后我们也确认过金额无误了。

#### 交割金额对照

我们通过邮件的方式来告知hjs应该往余额和卡里面各准备多少钱。以便我们来进行用户的汇款操作。所以hjs产品的汇款都是以我们要求的金额为准的。

#### 到期打款

上面是产品到期前和hjs进行金额对照。对照无误后，在到期当天，进行打款操作。还是找到产品，找到资产，然后为每一笔资产创建payback order，状态为SELL\_SUCCESS。后续会有跑批任务来进行真正的打款操作。

#### hjs加息

这里主要说按天加息券和加息券的逻辑吧。

资产到期的本息主要有三部分组成。1. 本金，2. 利息， 3.加息券产生的收益。在后台的逻辑里是支持一笔资产同时使用多个加息方式的。ps：加息券的逻辑还需要另起一个文章来进行说明。createAmount 和 CreateExpectedInterest是asset 表里面应该有的字段，加息券产生的利息应该放在另一个表里来进行存储，方便一对多。所以最后的计算方式就是createAmount+createExpectedInterest+extraInterest。

加息部分的钱是由我们来出的，hjs是不会给我们这部分钱的，但同时用户是不知道这个事情的，所以这就导致了我们的一个问题。如果用户用银行卡购买的话，根据同通道进出的原则，就会收到两笔打款。一笔本息一笔加息。这就给用户造成了很不好的体验，所以就有这样的一个策略：就是使用了某种加息规则购买的hjs产品都要回款到余额账户。在余额账户再通过某些hack的操作把两笔回款记录合并成为一笔。这样一来用户体验就会好很多。

#### hjs二级市场转让

hjs产品多为1年期的固定期限产品。但是总有一些用户有中途转让变现的需求，同时在转让的过程中平台会手续一定比例的手续费。所以支持转让是一个既能够方便用户也能为平台创造利润的需求。在某个时间点之后，增加hjs产品的转让功能。

二级市场的概念我理解就是购买非原始资产。

通过增加一个liquidate_asset表来实现。每一次变现都会生成一条liquidate\_asset记录。_









#### hjs关闭二级市场转让接口



